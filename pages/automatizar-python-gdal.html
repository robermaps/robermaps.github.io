<!DOCTYPE html>
<html lang="es">
<head>
	<title>Automatizar geoprocesos</title>	
	
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1"> 
	<meta name="google-site-verification" content="V6vOM4WVx1y0lZIvHHFBtzEfy8fyn3lMLuCdLiQkPtQ">
	
	<meta name="description" content="Portfolio de Roberto Jim√©nez - Especialista en Sistemas de Informaci√≥n Geogr√°fica y Geoespacial">
	<meta name="keywords" content="Automatizar, Geoprocesos, GDAL, OGR, Python">
	<meta name="author" content="Roberto Jim√©nez">

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="../styles/social.css">
	<link rel="stylesheet" href="../styles/styles.css">
	
	<link rel="icon" type="image/x-icon" href="favicon.ico">

		
</head>

	<body>
            
		<div class="cabecera">

			<div class="navbar">
				<ul>
					<li><a href="https://roberer.github.io/">Proyectos</a></li>
					<li><a class="active" href="https://roberer.github.io/tutoriales">Apuntes y tutoriales</a></li>
					<li><a href="https://roberer.github.io/blog">Blog</a></li>
					<li><a href="https://roberer.github.io/contacto">Contacto</a></li>
					<li style="float:right"><a href="https://twitter.com/roberer_" class="fa fa-twitter"></a></li>
					<li style="float:right"><a href="https://www.linkedin.com/in/robertojl" class="fa fa-linkedin"></a></li>
					<li style="float:right"><a href="https://github.com/roberer" class="fa fa-github"></a></li>
				</ul>
			</div>
	
	
			<div id="myNav" class="overlay">
				<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
				<div class="overlay-content">
					<a href="https://roberer.github.io/">Proyectos</a>
					<a class="active2" href="https://roberer.github.io/tutoriales">Tutoriales</a>
					<a href="https://roberer.github.io/blog">Blog</a>
					<a href="https://roberer.github.io/contacto">Contacto</a>
					<br><br>
					
						<div class="social-mobile">
							<div style="padding-right: 10px;"><a href="https://twitter.com/roberer_" class="fa fa-twitter"></a></div>
							<div style="padding-right: 10px;"><a href="https://www.linkedin.com/in/robertojl" class="fa fa-linkedin"></a></div>
							<div style="padding-right: 10px;"><a href="https://github.com/roberer" class="fa fa-github"></a></div>
						</div>
					
	
	
				</div>
			</div>
	
			<span style="font-size:30px;cursor:pointer" onclick="openNav()">
			<div class="navbar2">
				<div class="bar1"></div>
				<div class="bar2"></div>
				<div class="bar3"></div>
			</div></span>
	
	
			<div class="navbar3">
				<ul>
					<li style="color:rgb(0, 0, 0, 0,5); font-size:larger;" onclick="openNav()"><i>/tutoriales</i>üó∫Ô∏è</li>
					<li style="float:right"><span style="font-size:30px;cursor:pointer" onclick="openNav()">
						<div class="navbar2">
							<div class="bar1"></div>
							<div class="bar2"></div>
							<div class="bar3"></div>
						</div>
					</span></li>
					
				</ul>
			</div>
	
			<script>
	
				function openNav() {
					document.getElementById("myNav").style.width = "100%";
					}
	
					function closeNav() {
					document.getElementById("myNav").style.width = "0%";
				}
	
			</script>
	
				<div class="spacer"></div>

				<h1>Automatizar geoprocesos con Python y GDAL/OGR</h1>
				
			<div class="mifoto">
				<img alt="Roberer" src="https://raw.githubusercontent.com/roberer/roberer.github.io/main/img/img1.JPG">
			</div>
	
			
	
			<h2 align="center">Por Roberto Jim√©nez</h2>
			<h3 align="center" style="color:rgb(171, 171, 171)"><i>Geospatial & GIS specialist</i></h3>
		
				
		</div>
            

		<div class="cuerpo">

			<h4><strong>√çndice</strong></h4>
			<div class="indice">
			
			
					<ul>
						<li><a href="#introduccion">Python y GDAL</a><br></li>
						<li><a href="#script">El script de este post</a><br></li>
						<li><a href="#preparacion">Preparando el script</a><br></li>
						<li><a href="#mosaico">Generaci√≥n del mosaico</a><br></li>
						<li><a href="#curvas">Vectorizar y reproyectar curvas de nivel</a><br></li>
						<li><a href="#recorte">Recortar curvas por provincias</a><br></li>
						
					</ul>
						<br>
			</div>

		<p><a id="introduccion"></a></p>


<h2>Python y GDAL</h2>



<p>GDAL/OGR es, resumidamente, una librer√≠a de software de c√≥digo abierto para operar con datos espaciales. Est√° presente, entre otros lugares, en sistemas de informaci√≥n geogr√°fica como QGIS y permite trabajar tanto con datos r√°ster (GDAL) como vectoriales (OGR).</p>



<p>Entre las muchas formas de trabajar con GDAL/OGR se encuentra el Shell, una consola de comandos incluida en la instalaci√≥n del paquete de OSGEO con la que podemos hacer toda clase de operaciones con datos espaciales a trav√©s de instrucciones. Con ella es posible trabajar con grandes vol√∫menes de datos que de hacerlo mediante programas con interfaz gr√°fica resultar√≠a inviable.</p>



<p>Pues bien, una de las posibilidades que ofrece es la de ejecutar scripts de Python que automaticen la consecuci√≥n de comandos necesaria para lograr nuestro objetivo. Para ello, existe una funci√≥n llamada <em>os.system()</em> en la que podremos escribir comandos en formato texto o <em>array</em> para que sean ejecutados por el Shell.</p>






<p><a id="script"></a></p>


<h2>¬øEn qu√© consistir√° el script de este post?</h2>



<p>En este post voy a explicar el proceso para programar un script de Python que:</p>



<ol><li>Genere un mosaico MDE para toda Espa√±a a partir de otros MDE dispersos</li><li>Genere curvas de nivel a partir del mosaico. </li><li>Recorte las curvas de nivel seg√∫n la provincia a la que pertenezcan y se guarden en un √∫nico GeoPackage.</li></ol>



<p>El usuario tendr√° que especificar al ejecutar el script:</p>



<ul><li>La carpeta en la que se encuentran los MDE</li><li>La carpeta en la que se encuentran los shapefiles correspondientes a los l√≠mites administartivos de cada provincia</li><li>El sistema de referencia al que reproyectar las curvas de nivel (si lo desea)</li><li>La distancia en metros a la que se encontrar√°n las curvas de nivel </li></ul>



<p>‚ö† Para que funcione correctamente, hay que ejecutar este script desde el Shell de OSGeo con python3:</p>



<p style="background-color:#edc8b1;">C:\&gt; python3 script.py</p>



<p>Si python3 no estuviera configurado y saltara error habr√≠a que escribir<em> py3_env</em> y ejecutar. ¬°Ya estar√≠a listo!</p>






<p><a id="preparacion"></a></p>


<h2>Preparando el script</h2>



<p>Al principio del script pondremos todas aquellas cuestiones necesarias para que √©ste funcione correctamente, como la codificaci√≥n, los m√≥dulos o las variables introducidas por el usuario, as√≠ como la carpeta de salida en la que se guardar√° el geopackage:</p>


<pre>
# -*- coding: utf8 -*-

import os, shutil

# Valores de entrada del usuario
img_dir = str(input('Introduzca la ruta en la que se encuentran las imagenes: '))

prov_dir = str(input('Introduzca la ruta en la que se encuentran las provincias: '))

codigo = str(input('Introduzca el codigo EPSG al que quiere reproyectar las capas: ')) 

distancia = str(input('Introduzca la distancia entre curvas de nivel: '))


# Crear carpeta de salida
carpeta = f'{prov_dir}/cn{distancia}'

print(f'Creando la carpteta de salida -{carpeta}...')

if os.path.exists(carpeta):
    shutil.rmtree(carpeta)
    os.mkdir(carpeta)
    print('La carpeta ya esxistia y se ha sistituido por una nueva y vacia')
else:
    os.mkdir(carpeta)
    print('Carpeta creada')
</pre><br>





<p><a id="mosaico"></a></p>


<h2>Generaci√≥n del mosaico</h2>



<img src="https://programapa.files.wordpress.com/2021/07/image-2.png?w=1024" alt="" class="wp-image-7282" srcset="https://programapa.files.wordpress.com/2021/07/image-2.png?w=1024 1024w, https://programapa.files.wordpress.com/2021/07/image-2.png?w=150 150w, https://programapa.files.wordpress.com/2021/07/image-2.png?w=300 300w, https://programapa.files.wordpress.com/2021/07/image-2.png?w=768 768w, https://programapa.files.wordpress.com/2021/07/image-2.png 1363w" sizes="(max-width: 1024px) 100vw, 1024px" />



<p>El siguiente paso es generar un mosaico que una todos estos MDE en uno solo, del cual extraeremos las curvas de nivel. Para ello, crearemos un r√°ster virtual que nos permita trabajar m√°s adelante con todas estas im√°genes pero sin generar un nuevo y pesado archivo.</p>



<p>La funci√≥n de GDAL que lo permite es <em><strong>gdalbuildvrt</strong></em>:</p>


<pre>
print('Generando el raster virtual...')

# cambiar al directorio de las im√°genes 
os.chdir(img_dir)

# comando para crear un archivo de texto que liste los MDE
os.system('dir /b *.tif &gt; archivos.txt')

# comando para generar el mosaico en forma de raster virtual
os.system('gdalbuildvrt mosaico.vrt -input_file_list archivos.txt')

print('Raster virtual generado')
</pre><br>





<p><a id="curvas"></a></p>


<h2>Vectorizar y reproyectar curvas de nivel</h2>



<p>A partir del r√°ster virtual creado anteriormente podemos extraer las curvas de nivel con <em><strong>gdal_contour</strong></em>, adem√°s de reproyectarlas con <strong><em>ogr2ogr</em></strong> al SRC que introdujo el usuario:</p>


<pre>
# Vectorizacion de curvas de nivel
print('Vectorizando curvas de nivel...')

os.system(f'gdal_contour -a elev -i {distancia} mosaico.vrt cn{distancia}.shp')

print('Curvas de nivel vectorizadas')

# Reproyeccion
print(f'Reproyectando las curvas de nivel a EPSG:{codigo}')

os.system(f'ogr2ogr -t_srs EPSG:{codigo} cn{distancia}_rep.shp cn{distancia}.shp')

print(f'Las curvas se han reproyectado a EPSG:{codigo}')
</pre><br>






<img src="https://programapa.files.wordpress.com/2021/07/image-3.png?w=1024" alt="" class="wp-image-7283" srcset="https://programapa.files.wordpress.com/2021/07/image-3.png?w=1024 1024w, https://programapa.files.wordpress.com/2021/07/image-3.png?w=150 150w, https://programapa.files.wordpress.com/2021/07/image-3.png?w=300 300w, https://programapa.files.wordpress.com/2021/07/image-3.png?w=768 768w, https://programapa.files.wordpress.com/2021/07/image-3.png 1168w" sizes="(max-width: 1024px) 100vw, 1024px" />






<p><a id="recorte"></a></p>


<h2>Recortar las curvas de nivel y guardarlas en un geopackage separadas seg√∫n su provincia</h2>



<p>Antes de llevar a cabo la √∫ltima tarea, conviene <strong>crear un √≠ndice espacial</strong> para la capa de curvas de nivel, ya que <strong>mejorar√° mucho el rendimiento del recorte</strong>:</p>


<pre>
print('Creando indice espacial...')

os.system(f'ogrinfo cn{distancia}_rep.shp -sql "CREATE SPATIAL INDEX ON cn{distancia}_rep"')

print('Indice espacial creado')
</pre><br>


<p>Ahora s√≠, con el siguiente c√≥digo lograremos separar las curvas de nivel en capas separadas seg√∫n la provincia a la que pertenezcan. </p>



<p>El recorte se har√° tambi√©n con el comando <em><strong>ogr2ogr</strong></em></p>



<p>El GeoPackage es creado en el momento en el que se lleva a cabo el primer recorte. Para evitar que sea sobrescrito por los siguientes recortes y se vayan almacenando uno a uno, tendremos que hacer que se le a√±ada autom√°ticamente la cl√°usula -update una vez se haya hecho ese primer recorte. Esto lo haremos con los contadores:</p>


<pre>
print('Recortando las curvas de nivel para cada provincia en un nuevo archivo GeoPackage...')

# Cambiar a la carpeta de provincias
os.chdir(prov_dir)

# Creacion de contadores
count = 0
update = ''

# Iterar sobre los archivos de la carpeta de provincias
for provincia in os.listdir(prov_dir):

    # si los archivos son shapes...
    if provincia.endswith('.shp'):

        # a√±adir -update al comando 
        if count &gt; 1:
            update = '-update'

        nombre = os.path.splitext(provincia)&#91;0]
        print(f'Recortando curvas de nivel para la provincia de {nombre}')

        # comando para recortar capas
        os.system(f'ogr2ogr -f GPKG {carpeta}/cn{distancia}.gpkg -progress -clipsrc {provincia} {img_dir}/cn{distancia}_rep.shp {update} -nln {nombre}')

        # incrementar el contador
        count += 1

        print(f'Curvas de nivel para la provincia de {nombre} recortadas')

print('Terminado')
</pre><br>






<p>El resultado es satisfactorio salvo por errores de geometr√≠a en la provincia de √Ålava y en la isla de Mallorca, pero nada grave. El GeoPackage contiene las curvas de nivel separadas seg√∫n la provincia:</p>



<img src="https://programapa.files.wordpress.com/2021/07/image-5.png?w=1024" alt="" class="wp-image-7287" srcset="https://programapa.files.wordpress.com/2021/07/image-5.png?w=1024 1024w, https://programapa.files.wordpress.com/2021/07/image-5.png?w=150 150w, https://programapa.files.wordpress.com/2021/07/image-5.png?w=300 300w, https://programapa.files.wordpress.com/2021/07/image-5.png?w=768 768w, https://programapa.files.wordpress.com/2021/07/image-5.png 1516w" sizes="(max-width: 1024px) 100vw, 1024px" />



<p>Ten√©is el c√≥digo completo <a href="https://github.com/roberer/GDAL-OGR/blob/main/mosaico_recorte_curvas.py" target="_blank" rel="noreferrer noopener"><span style="text-decoration:underline;">en mi GitHub</span></a></p>
		
		</div>
	
	</body>
</html>
